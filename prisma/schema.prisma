// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model WebhookEvent {
  id               String                @id
  type             String
  mode             String
  timestamp        DateTime
  replyToken       String?
  isRedelivery     Boolean?              @default(false)
  lineWebhookEvent Json                  @default("{}")
  lineWebhooks     lineWebhookDelivery[]
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @default(now())
}

model LineWebhook {
  destination    String
  xLineSignature String
  webhookEvents  lineWebhookDelivery[]
  createdAt      DateTime              @default(now())

  @@id([xLineSignature, createdAt])
}

model lineWebhookDelivery {
  WebhookEvent              WebhookEvent? @relation(fields: [webhookEventId], references: [id])
  isRedelivery              Boolean?      @default(false)
  webhookEventId            String
  LineWebhook               LineWebhook?  @relation(fields: [lineWebhookXLineSignature, lineWebhookCreatedAt], references: [xLineSignature, createdAt])
  lineWebhookXLineSignature String
  lineWebhookCreatedAt      DateTime

  @@id([webhookEventId, lineWebhookXLineSignature, lineWebhookCreatedAt])
}
